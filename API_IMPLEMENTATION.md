# Lovendar API実装ガイド

## 概要

LovendarアプリにAPI通信機能を実装しました。ローカル環境と本番環境の切り替えができ、認証機能、スワイプでのデータ更新に対応しています。

## 実装した機能

### 1. API通信基盤
- **APIConfig.swift**: API環境設定（ローカル/本番の切り替え）
- **APIService.swift**: 汎用的なAPI通信サービス
- **NetworkError.swift**: エラーハンドリング
- **APIModels.swift**: APIレスポンス用のモデル

### 2. 認証機能
- **AuthManager.swift**: 認証状態とトークンの管理
- **AuthService.swift**: ログイン・新規登録のAPI通信
- **AuthView.swift**: ログイン・新規登録画面
- **AuthViewModel.swift**: 認証画面のロジック

### 3. API通信サービス
- **OshiService.swift**: 推し管理API
- **EventService.swift**: イベント管理API
- **CommonService.swift**: 共通情報API

### 4. 既存機能の拡張
- **OshiViewModel**: APIからデータ取得、スワイプリフレッシュ対応
- **CalendarViewModel**: APIからデータ取得、スワイプリフレッシュ対応
- **SettingsView**: ログアウト、環境切り替え機能追加
- すべてのListViewにスワイプリフレッシュ機能追加

## セットアップ手順

### 1. Xcodeプロジェクトへのファイル追加

以下のファイルをXcodeプロジェクトに追加してください：

#### Core フォルダ
- `APIConfig.swift`
- `APIService.swift`
- `AuthManager.swift`
- `AuthService.swift`
- `NetworkError.swift`
- `OshiService.swift`
- `EventService.swift`
- `CommonService.swift`

#### Auth フォルダ（新規作成）
- `AuthView.swift`
- `AuthViewModel.swift`

#### Shared フォルダ
- `APIModels.swift`

**Xcodeでの追加手順:**
1. プロジェクトナビゲータで `Lovendar` フォルダを右クリック
2. "Add Files to Lovendar..." を選択
3. 上記のファイルを選択して追加
4. "Copy items if needed" にチェックを入れる

### 2. API環境設定

デフォルトではローカル環境（`http://localhost:8080/api`）に設定されています。

本番環境のURLを変更するには、`APIConfig.swift` を編集してください：

```swift
case .production:
    return "https://your-production-api.com/api" // 本番環境のURLに変更
```

### 3. アプリ起動時の動作

- 初回起動時は自動的にログイン画面が表示されます
- 一度ログインすると、トークンが保存され次回以降は自動ログインされます
- ログアウトは設定画面から行えます

## 使い方

### ログイン・新規登録

1. アプリを起動すると認証画面が表示されます
2. **新規登録の場合:**
   - "アカウントをお持ちでない方はこちら" をタップ
   - 名前、メールアドレス、パスワード（8文字以上）を入力
   - "登録" ボタンをタップ
3. **ログインの場合:**
   - メールアドレスとパスワードを入力
   - "ログイン" ボタンをタップ

### 環境の切り替え

1. 設定画面を開く
2. "API環境" セクションで環境を選択
   - **ローカル**: ローカルサーバー（開発用）
   - **本番**: 本番サーバー
3. 現在のベースURLが表示されます

### データの更新（スワイプリフレッシュ）

以下の画面でスワイプダウンでデータを更新できます：

- **カレンダー画面**: イベント一覧を更新
- **推し一覧画面**: 推しリストを更新

スワイプダウンすると自動的にAPIからデータを取得します。

### ログアウト

1. 設定画面を開く
2. "ユーザー情報" セクションの "ログアウト" ボタンをタップ
3. 確認ダイアログで "ログアウト" を選択

## API仕様

詳細なAPI仕様は `.cursor/rules/api-reference.mdc` を参照してください。

### 主要エンドポイント

#### 認証
- `POST /auth/register` - 新規登録
- `POST /auth/login` - ログイン

#### 推し管理
- `GET /me/oshis` - 推し一覧取得
- `POST /me/oshis/new` - 推し作成
- `PUT /me/oshis/{oshiId}` - 推し更新

#### イベント管理
- `GET /me/events` - イベント一覧取得
- `GET /me/events/{eventId}` - イベント詳細取得
- `POST /me/events/new` - イベント作成
- `PUT /me/events/{eventId}` - イベント更新

#### 共通情報
- `GET /common` - カテゴリ一覧などの共通情報取得

## データフロー

### 認証されていない場合
1. サンプルデータが表示されます
2. ログイン画面からログインできます

### 認証されている場合
1. アプリ起動時に自動的にAPIからデータを取得
2. スワイプでリフレッシュすると再取得
3. データ作成・更新時はAPIに送信

## エラーハンドリング

- ネットワークエラー時は自動的にサンプルデータを表示
- エラーメッセージは日本語で表示されます
- 認証エラー時は自動的にログイン画面に遷移

## 注意事項

### ローカルサーバーの起動

ローカル環境を使用する場合は、バックエンドサーバーを起動してください：

```bash
# サーバーのポート: 8080
# ベースURL: http://localhost:8080/api
```

### 本番環境への切り替え

本番環境を使用する前に：

1. `APIConfig.swift` の本番URLを正しく設定
2. HTTPSを使用していることを確認
3. Info.plistでApp Transport Security (ATS)の設定を確認

## トラブルシューティング

### ビルドエラーが発生する場合

1. すべての新規ファイルがXcodeプロジェクトに追加されているか確認
2. Clean Build Folder (Cmd+Shift+K)
3. Derived Data を削除して再ビルド

### API通信がうまくいかない場合

1. 環境設定が正しいか確認（設定画面で確認）
2. ローカルサーバーが起動しているか確認
3. ネットワーク接続を確認
4. Xcodeのコンソールログを確認

### 認証がうまくいかない場合

1. メールアドレスとパスワードが正しいか確認
2. パスワードが8文字以上か確認
3. サーバーが正しく動作しているか確認

## 開発時のヒント

### デバッグ

- APIリクエスト/レスポンスはXcodeのコンソールに出力されます
- エラー発生時は詳細なエラーメッセージが表示されます

### 新しいAPIエンドポイントの追加

1. `APIModels.swift` にリクエスト/レスポンスモデルを追加
2. 対応するServiceクラスにメソッドを追加
3. ViewModelから呼び出す

## 今後の拡張性

このAPI実装は以下の拡張に対応できます：

- オフラインモード対応
- キャッシュ機能の追加
- リトライロジックの追加
- より詳細なエラーハンドリング
- アナリティクス連携

## サポート

問題が発生した場合は、以下の情報を含めて報告してください：

- 発生したエラーメッセージ
- 使用している環境（ローカル/本番）
- 実行した操作の手順
- Xcodeのコンソールログ

